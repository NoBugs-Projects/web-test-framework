<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web Test Framework - Reports Dashboard</title>
    <link rel="stylesheet" href="report_styles.css">
    <link rel="icon" type="image/png" href="logo_icon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 8px;
        }
        
        /* Responsive design for different screen sizes */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            .chart-container canvas {
                max-height: 240px;
            }
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 6px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 8px;
            }
            .chart-container canvas {
                max-height: 280px;
            }
        }
        
        @media (min-width: 1025px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 10px;
            }
            .chart-container canvas {
                max-height: 320px;
            }
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 3px solid #007bff;
        }
        
        .kpi-card.critical { border-left-color: #dc3545; }
        .kpi-card.warning { border-left-color: #ffc107; }
        .kpi-card.success { border-left-color: #28a745; }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .kpi-label {
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chart-container {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            overflow: hidden;
        }
        
        .chart-container canvas {
            max-width: 100%;
            height: auto !important;
        }
        
        .chart-title {
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .gauge-container {
            text-align: center;
            padding: 8px;
        }
        
        .gauge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 8px;
            position: relative;
            background: conic-gradient(
                var(--gauge-color) 0deg,
                var(--gauge-color) calc(var(--percentage) * 3.6deg),
                #f0f0f0 calc(var(--percentage) * 3.6deg),
                #f0f0f0 360deg
            );
        }
        
        .gauge::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
        }
        
        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            font-weight: bold;
            color: var(--gauge-color);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-passed { background: #28a745; }
        .status-failed { background: #dc3545; }
        .status-skipped { background: #6c757d; }
        .status-flaky { background: #ffc107; }
        .status-critical { background: #dc3545; }
        
        .coverage-bar {
            background: #f0f0f0;
            border-radius: 6px;
            height: 12px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .coverage-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .coverage-low { background: #dc3545; }
        .coverage-medium { background: #ffc107; }
        .coverage-high { background: #28a745; }
        
        .metric-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.8rem;
        }
        
        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .alert-banner.success {
            background: linear-gradient(135deg, #51cf66, #40c057);
        }
        
        .alert-banner.warning {
            background: linear-gradient(135deg, #ffd43b, #fcc419);
            color: #333;
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <div class="header">
        <div class="logo-container">
            <div class="logo">
                <img src="logo_icon.png" alt="NoBugs Logo" />
            </div>
            <h1>Web Test Framework - Analytics Dashboard</h1>
        </div>
        <p id="run-info">Comprehensive Test Reports Dashboard - Run #__RUN_NUMBER__</p>
    </div>

    <!-- Alert Banner for Critical Issues -->
    <div id="alert-banner" class="alert-banner" style="display: none;">
        <div>
            <strong>‚ö†Ô∏è Critical Issues Detected</strong>
            <p id="alert-message" style="margin: 5px 0 0 0; font-size: 0.9rem;"></p>
        </div>
        <button onclick="this.parentElement.style.display='none'" style="background: none; border: none; color: inherit; font-size: 1.2rem; cursor: pointer;">√ó</button>
    </div>

    <!-- üìä 1. Test Status Overview -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Test Execution Status</h2>
        
        <!-- KPI Cards for Test Status -->
        <div class="kpi-grid">
            <div class="kpi-card" id="pass-rate-card">
                <div class="kpi-label">Pass Rate</div>
                <div class="kpi-value" id="pass-rate-value">{{ALLURE_PASS_RATE}}%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="pass-rate-fill" style="width: {{ALLURE_PASS_RATE}}%"></div>
                </div>
            </div>
            
            <div class="kpi-card" id="total-tests-card">
                <div class="kpi-label">Total Tests</div>
                <div class="kpi-value" id="total-tests-value">{{ALLURE_TOTAL_TESTS}}</div>
                <div class="metric-details">
                    <span id="passed-tests">{{ALLURE_PASSED_TESTS}} passed</span>
                    <span id="failed-tests">{{ALLURE_FAILED_TESTS}} failed</span>
                </div>
            </div>
            
            <div class="kpi-card" id="avg-duration-card">
                <div class="kpi-label">Average Duration</div>
                <div class="kpi-value" id="avg-duration-value">{{ALLURE_AVG_DURATION}}</div>
                <div class="metric-details">
                    <span>Total: <span id="total-duration">{{ALLURE_TOTAL_DURATION}}</span></span>
                </div>
            </div>
            
            <div class="kpi-card" id="critical-failures-card">
                <div class="kpi-label">Critical Failures</div>
                <div class="kpi-value" id="critical-failures-value">{{ALLURE_CRITICAL_FAILURES}}</div>
                <div class="metric-details">
                    <span id="flaky-tests">{{ALLURE_FLAKY_TESTS}} flaky</span>
                </div>
            </div>
            
            <div class="kpi-card" id="skipped-tests-card">
                <div class="kpi-label">Skipped Tests</div>
                <div class="kpi-value" id="skipped-tests">{{ALLURE_SKIPPED_TESTS}}</div>
            </div>
            
        </div>
        
                  <!-- Test Status Distribution Chart -->
          <div class="charts-grid">
              <div class="chart-container">
                  <h3>Test Status Distribution</h3>
                  <canvas id="testStatusChart" width="300" height="320"></canvas>
              </div>
          </div>
    </div>

    <!-- ‚öôÔ∏è 2. API Coverage Analysis -->
    <div class="chart-container">
        <h2 class="chart-title">‚öôÔ∏è API Coverage Analysis</h2>
        
        <!-- Coverage KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card" id="api-coverage-card">
                <div class="kpi-label">API Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="api-coverage-gauge">
                        <div class="gauge-value" id="api-coverage-value">{{SWAGGER_API_COVERAGE}}%</div>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card" id="conditions-coverage-card">
                <div class="kpi-label">Conditions Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="conditions-coverage-gauge">
                        <div class="gauge-value" id="conditions-coverage-value">{{SWAGGER_CONDITIONS_COVERAGE}}%</div>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card" id="full-coverage-card">
                <div class="kpi-label">Full Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="full-coverage-gauge">
                        <div class="gauge-value" id="full-coverage-value">{{SWAGGER_FULL_COVERAGE}}%</div>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card" id="partial-coverage-card">
                <div class="kpi-label">Partial Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="partial-coverage-gauge">
                        <div class="gauge-value" id="partial-coverage-value">{{SWAGGER_PARTIAL_COVERAGE}}%</div>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card" id="empty-coverage-card">
                <div class="kpi-label">Empty Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="empty-coverage-gauge">
                        <div class="gauge-value" id="empty-coverage-value">{{SWAGGER_EMPTY_COVERAGE}}%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Operations and Tags Coverage -->
        <div class="kpi-grid">
            <div class="kpi-card" id="operations-coverage-card">
                <div class="kpi-label">Operations Coverage</div>
                <div class="kpi-value" id="operations-coverage-value">{{SWAGGER_OPERATIONS_COVERAGE}}%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="operations-coverage-fill" style="width: {{SWAGGER_OPERATIONS_COVERAGE}}%"></div>
                </div>
                <div class="metric-details">
                    <span>Covered: <span id="covered-operations">{{SWAGGER_COVERED_OPERATIONS}}</span></span>
                    <span>Total: <span id="total-operations">{{SWAGGER_TOTAL_OPERATIONS}}</span></span>
                </div>
            </div>
            
            <div class="kpi-card" id="tags-coverage-card">
                <div class="kpi-label">Tags Coverage</div>
                <div class="kpi-value" id="tags-coverage-value">{{SWAGGER_TAGS_COVERAGE}}%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="tags-coverage-fill" style="width: {{SWAGGER_TAGS_COVERAGE}}%"></div>
                </div>
                <div class="metric-details">
                    <span>Covered: <span id="covered-tags">{{SWAGGER_COVERED_TAGS}}</span></span>
                    <span>Total: <span id="total-tags">{{SWAGGER_TOTAL_TAGS}}</span></span>
                </div>
            </div>
        </div>
        
        <!-- API Coverage Charts -->
        <div class="charts-grid">
                          <div class="chart-container">
                  <h3>HTTP Method Coverage</h3>
                  <canvas id="methodCoverageChart" width="300" height="360"></canvas>
              </div>
              
              <div class="chart-container">
                  <h3>Status Code Coverage</h3>
                  <canvas id="statusCodeChart" width="300" height="360"></canvas>
              </div>
        </div>
        

    </div>

    <!-- Reports Section -->
    <div class="reports-section">
        <h2>üìã Detailed Reports</h2>
        <div class="reports-grid">
            <div class="report-card">
                <div class="report-icon">üìä</div>
                <h3>Allure Test Report</h3>
                <p>Comprehensive test execution results with detailed analytics, screenshots, and performance metrics.</p>
                <a href="#" id="allure-link" class="btn" target="_blank">
                    <span class="status-indicator"></span>
                    View Allure Report
                </a>
            </div>

            <div class="report-card">
                <div class="report-icon pink">üîç</div>
                <h3>Swagger Coverage Report</h3>
                <p>API endpoint coverage analysis showing which endpoints have been tested and their current status.</p>
                <a href="#" id="swagger-link" class="btn pink" target="_blank">
                    <span class="status-indicator"></span>
                    View Swagger Coverage
                </a>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>
            Built with <strong style="color: #08fc04;">NoBugs</strong> ‚ù§Ô∏è for quality assurance
        </p>
    </div>
</div>

<script>
    const injectedRunNumber = "__RUN_NUMBER__";
    let charts = {};

    function getCoverageColor(percentage) {
        if (percentage < 20) return '#dc3545';
        if (percentage < 70) return '#ffc107';
        return '#28a745';
    }

    function updateGauge(elementId, percentage) {
        const gauge = document.getElementById(elementId);
        const value = gauge.querySelector('.gauge-value');
        const color = getCoverageColor(percentage);
        
        gauge.style.setProperty('--percentage', percentage);
        gauge.style.setProperty('--gauge-color', color);
        value.textContent = `%`;
        value.style.color = color;
    }

    function updateKPI(elementId, value, suffix = '') {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value + suffix;
        }
    }

    function updateCoverageBar(elementId, percentage) {
        const fill = document.getElementById(elementId);
        const color = getCoverageColor(percentage);
        fill.style.width = `%`;
        fill.className = `coverage-fill ${percentage < 20 ? 'coverage-low' : percentage < 70 ? 'coverage-medium' : 'coverage-high'}`;
    }

    function createTestStatusChart(data) {
        const ctx = document.getElementById('testStatusChart').getContext('2d');
        
        if (charts.testStatus) {
            charts.testStatus.destroy();
        }
        
        const colors = {
            passed: '#28a745',
            failed: '#dc3545',
            skipped: '#6c757d',
            flaky: '#ffc107',
            critical: '#dc3545'
        };
        
        charts.testStatus = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Passed', 'Failed', 'Skipped', 'Flaky', 'Critical'],
                datasets: [{
                    data: [
                        data.passedTests || 0,
                        data.failedTests || 0,
                        data.skippedTests || 0,
                        data.flakyTests || 0,
                        data.criticalFailures || 0
                    ],
                    backgroundColor: [
                        colors.passed,
                        colors.failed,
                        colors.skipped,
                        colors.flaky,
                        colors.critical
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 3,
                        bottom: 3,
                        left: 3,
                        right: 3
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 3,
                            font: {
                                size: 8
                            },
                            boxWidth: 8,
                            boxHeight: 8
                        }
                    }
                }
            }
        });
    }



    function createMethodCoverageChart(data) {
        const ctx = document.getElementById('methodCoverageChart').getContext('2d');
        
        if (charts.methodCoverage) {
            charts.methodCoverage.destroy();
        }
        
        const methodData = data.methodCoverage || {};
        const methods = Object.keys(methodData);
        const covered = methods.map(method => methodData[method].coverage || 0);
        const total = methods.map(method => methodData[method].total || 0);
        
        charts.methodCoverage = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: methods,
                datasets: [{
                    label: 'Coverage %',
                    data: covered,
                    backgroundColor: covered.map(c => getCoverageColor(c)),
                    borderColor: covered.map(c => getCoverageColor(c)),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 5,
                        bottom: 5
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Coverage %'
                        },
                        ticks: {
                            font: {
                                size: 8
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 8
                            }
                        }
                    }
                }
            }
        });
    }

    function createStatusCodeChart(data) {
        const ctx = document.getElementById('statusCodeChart').getContext('2d');
        
        if (charts.statusCode) {
            charts.statusCode.destroy();
        }
        
        const statusData = data.statusCodeCoverage || {};
        const codes = Object.keys(statusData);
        const counts = codes.map(code => statusData[code] || 0);
        
        charts.statusCode = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: codes,
                datasets: [{
                    label: 'Coverage Count',
                    data: counts,
                    backgroundColor: '#007bff',
                    borderColor: '#0056b3',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 5,
                        bottom: 5
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        },
                        ticks: {
                            font: {
                                size: 8
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 8
                            }
                        }
                    }
                }
            }
        });
    }

    function checkCriticalIssues(data) {
        const issues = [];
        
        if (data.allure) {
            if (data.allure.passRate < 50) {
                issues.push(`Low pass rate: ${data.allure.passRate}%`);
            }
            if (data.allure.criticalFailures > 0) {
                issues.push(`${data.allure.criticalFailures} critical failures detected`);
            }
        }
        
        if (data.swagger) {
            if (data.swagger.apiCoverage < 20) {
                issues.push(`Low API coverage: ${data.swagger.apiCoverage}%`);
            }
            if (data.swagger.emptyCoverage > 80) {
                issues.push(`High empty coverage: ${data.swagger.emptyCoverage}%`);
            }
        }
        
        return issues;
    }

    function updateDashboard(data) {
        // Initialize charts with actual data from metrics.json
        console.log('Initializing charts with metrics.json data:', data);
        
        // Create test status chart with actual Allure data
        if (data.allure) {
            createTestStatusChart(data.allure);
        }
        
        // Create method coverage chart with actual Swagger data
        if (data.swagger) {
            createMethodCoverageChart(data.swagger);
            createStatusCodeChart(data.swagger);
        }
    }

    function formatDuration(seconds) {
        if (seconds >= 60) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `m s`;
        }
        return `s`;
    }

    function updateCardColor(cardId, value) {
        const card = document.getElementById(cardId);
        if (!card) return;
        
        card.className = 'kpi-card';
        if (cardId.includes('pass-rate')) {
            if (value < 50) card.classList.add('critical');
            else if (value < 80) card.classList.add('warning');
            else card.classList.add('success');
        } else if (cardId.includes('critical-failures')) {
            if (value > 0) card.classList.add('critical');
            else card.classList.add('success');
        }
    }

    function buildReportUrls() {
        const runNumber = injectedRunNumber;
        const currentPath = window.location.pathname;
        const baseUrl = window.location.origin + currentPath.substring(0, currentPath.lastIndexOf('/'));

        const allureUrl = `/allure-report.html`;
        const swaggerUrl = `/swagger-coverage-report.html`;

        document.getElementById('allure-link').href = allureUrl;
        document.getElementById('swagger-link').href = swaggerUrl;

        const runInfo = document.getElementById('run-info');
        if (runInfo) {
            runInfo.textContent = `Comprehensive Test Reports Dashboard - Run #`;
        }
    }

    function loadMetrics() {
        fetch('metrics.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Metrics file not found, using placeholder data');
                }
                return response.json();
            })
            .then(data => {
                console.log('Loaded metrics:', data);
                updateDashboard(data);
            })
            .catch(error => {
                console.warn('Using placeholder metrics:', error.message);
                
                const placeholderData = {
                    allure: {
                        passRate: 85,
                        criticalFailures: 0,
                        flakyRate: 5,
                        avgDuration: 30,
                        totalTests: 39,
                        passedTests: 33,
                        failedTests: 4,
                        skippedTests: 2,
                        flakyTests: 2,
                        totalDuration: 1170
                    },
                    swagger: {
                        apiCoverage: 4.1,
                        conditionsCoverage: 4.1,
                        methodCoverage: { 
                            GET: { coverage: 85, total: 200 }, 
                            POST: { coverage: 70, total: 150 },
                            PUT: { coverage: 60, total: 50 },
                            DELETE: { coverage: 40, total: 33 }
                        },
                        statusCodeCoverage: { "200": 15, "400": 8, "403": 5, "404": 3, "500": 2 },
                        totalOperations: 433,
                        coveredOperations: 18,
                        totalTags: 30,
                        coveredTags: 7,
                        totalConditions: 1885,
                        coveredConditions: 77,
                        fullCoverage: 0.462,
                        partialCoverage: 2.309,
                        emptyCoverage: 97.229
                    }
                };
                
                updateDashboard(placeholderData);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        buildReportUrls();
        loadMetrics();
    });
</script>
</body>
</html>
